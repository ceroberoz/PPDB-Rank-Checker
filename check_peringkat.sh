#!/bin/bash

# File to store the last seen value
LAST_VALUE_FILE="./last_peringkat.txt"

# Fetch the JSON (replace with your curl command)
JSON=$(curl 'https://spmb.bogorkab.go.id/v2/ppdb-service/pendaftaran/pendaftaranDaftarPilihanSekolah' \
  -H 'Accept: application/json, text/plain, */*' \
  -H 'Accept-Language: en-US,en;q=0.9' \
  -H 'Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpbnN0YW5zaV9wZXJhbl9wZW5nZ3VuYV9pZCI6IjQxRjZDQzc0LTlBMkYtNEY4MC05Q0VFLTQ0QzlFQUQ5NjZFRSIsInBlbmdndW5hX2lkIjoiNTY4ODI2OEYtRjhBQi00MTZFLTk4QzQtNTg1NjQ2MkVFQTY4IiwidXNlcm5hbWUiOiJlNTljYWM2MjhkQHNwbWIuZ28uaWQiLCJuaWsiOiIzMjAxMTMxMzEyMTgwMDAzIiwibmlzbiI6IiAgICAgICAgICAiLCJuYW1hIjoiRGFuaXN3YXJhIFJha2EgU2FuamF5YSIsInRlbXBhdF9sYWhpciI6Impha2FydGEgIiwidGFuZ2dhbF9sYWhpciI6IjIwMTgtMTItMTMiLCJuYW1hX2lidV9rYW5kdW5nIjoiSGVyaW50aWEgUHVzcGFyYW5pIiwibmlrX2lidSI6IjMyMDExMzcxMDE5MDAwMDMiLCJqZW5pc19rZWxhbWluIjoiTCIsIm5hbWFfYXlhaCI6IlBlcmRhbmEgSGFkaSBTYW5qYXlhIiwibmlrX2F5YWgiOiIzMjAxMTMxNzA3OTAwMDA2IiwibmFtYV93YWxpIjoiIiwibmlrX3dhbGkiOiIgICAgICAgICAgICAgICAgIiwiYWxhbWF0X2phbGFuIjoia3AuIGtlbGFwYSIsInJ0Ijo1LCJydyI6MywibmFtYV9kdXN1biI6IiIsImtvZGVfd2lsYXlhaCI6IjAyMDUyMkFFICAiLCJrb2RlX3BhZHVrdWhhbiI6bnVsbCwicGFkdWt1aGFuIjpudWxsLCJrb2RlX2Rlc2Ffa2VsdXJhaGFuIjoiMDIwNTIyQUUgICIsImRlc2Ffa2VsdXJhaGFuIjoiU3VzdWthbiIsImtvZGVfa2VjYW1hdGFuIjoiMDIwNTIyICAgICIsImtlY2FtYXRhbiI6IktlYy4gQm9qb25nIEdlZGUiLCJrb2RlX2thYnVwYXRlbiI6IjAyMDUwMCAgICAiLCJrYWJ1cGF0ZW4iOiJLYWIuIEJvZ29yIiwia29kZV9wcm92aW5zaSI6IjAyMDAwMCAgICAiLCJwcm92aW5zaSI6IlByb3YuIEphd2EgQmFyYXQiLCJsaW50YW5nIjotNi40NTU1MDE3LCJidWp1ciI6MTA2Ljc3ODQzNSwia2VidXR1aGFuX2todXN1c19pZCI6MCwia2VidXR1aGFuX2todXN1cyI6IlRpZGFrIEFkYSIsImFnYW1hX2lkIjoxLCJhZ2FtYSI6IklzbGFtIiwibm9tb3Jfa29udGFrIjoiMDg1NzgwOTA5MTQ3Iiwibm9tb3JfdWppYW4iOiIgICAgICAgICAgICAgICAgICAgICIsIm5vbW9yX2tpcCI6IiIsIm5vbW9yX3BraCI6IiIsIm5vbW9yX2trIjoiMzIwMTEzMzAwODE4MDAxNCIsInRhbmdnYWxfa2siOiIyMDIwLTAyLTExIiwiZmxhZ19ra19zYXR1X3RhaHVuIjowLCJmbGFnX2R0a3MiOjAsImZsYWdfb3JhbmdfdHVhX2d1cnUiOjAsImluc3RhbnNpX2lkX29yYW5nX3R1YSI6bnVsbCwiaW5zdGFuc2lfb3JhbmdfdHVhIjpudWxsLCJ2ZXJpZmlrYXNpX2Jpb2RhdGEiOjEsInZlcmlmaWthdG9yX2Jpb2RhdGEiOm51bGwsInRhbmdnYWxfdmVyaWZpa2FzaV9iaW9kYXRhIjpudWxsLCJqZW5qYW5nX2lkIjoyLCJqZW5qYW5nIjoiU0QiLCJwZW5nZ3VuYWFuX3BldGEiOjEsInBlbmdndW5hYW5fcmFwb3J0IjowLCJwZW5nZ3VuYWFuX2JlcmthcyI6MSwicGVuZ2d1bmFhbl9wcmVzdGFzaSI6MCwiaW5zdGFuc2lfaWQiOiIzQjc0RUQ1OC00RUQxLTQ2NDItQTZCOC03NDI0NEZCOTE1OTMiLCJpbnN0YW5zaSI6IjAwMDAwMDAwIC0gQkVMVU0gQkVSU0VLT0xBSCIsImtvZGVfa2FidXBhdGVuX2luc3RhbnNpIjoiMDIwNTAwIiwic3RhdHVzX2luc3RhbnNpIjoiUyIsInBlcmFuX2lkIjoxLCJwZXJhbiI6IlNpc3dhL09yYW5ndHVhIiwic3RhdHVzX2Jpb2RhdGEiOiJUZXJ2ZXJpZmlrYXNpIiwiamVuaXNfdGluZ2dhbF9pZCI6MCwiamVuaXNfdGluZ2dhbCI6IlRpZGFrIEFkYSIsInJlZ2lzdHJhc2kiOjEsInNpc3dhX3VuZ2dhaF9iZXJrYXMiOjEsInNpc3dhX2hhcHVzX2JlcmthcyI6MSwic2lzd2FfdGFtYmFoX3ByZXN0YXNpIjowLCJzaXN3YV9oYXB1c19wcmVzdGFzaSI6MCwic2lzd2FfdWJhaF9wcmVzdGFzaSI6MCwicGVuZ2d1bmFhbl9iZXJrYXNfcHJlc3Rhc2kiOjAsInNpc3dhX3RhbWJhaF9uaWxhaV9yYXBvcnQiOjAsInNpc3dhX2hhcHVzX25pbGFpX3JhcG9ydCI6MCwidXNpYSI6MjM5MiwicGVuZ2d1bmFhbl9iYXRhc193aWxheWFoIjowLCJrbGFzaWZpa2FzaV9ra19pZCI6MCwiZHRrc19wZW1hZGFuYW4iOjAsImR0a3Nfa2VsdWFyZ2FfcGtoIjowLCJkdGtzX2tlbHVhcmdhX2JwbnQiOjAsImR0a3NfYW5nZ290YV9wYmkiOjAsImR0a3NfYWt0aWYiOjAsImR0a3NfcGVyaW9kZV9zayI6bnVsbCwiZHVrY2FwaWxfcGVtYWRhbmFuIjoxLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX25payI6IlNlc3VhaSIsImR1a2NhcGlsX2tldGVyYW5nYW5fbmFtYSI6IlNlc3VhaSAoMTAwKSIsImR1a2NhcGlsX2tldGVyYW5nYW5fdGVtcGF0X2xhaGlyIjoiU2VzdWFpICgxMDApIiwiZHVrY2FwaWxfa2V0ZXJhbmdhbl90YW5nZ2FsX2xhaGlyIjoiU2VzdWFpIiwiZHVrY2FwaWxfa2V0ZXJhbmdhbl9qZW5pc19rZWxhbWluIjoiU2VzdWFpIiwiZHVrY2FwaWxfa2V0ZXJhbmdhbl9ub21vcl9rayI6IlNlc3VhaSIsImR1a2NhcGlsX2tldGVyYW5nYW5fYWxhbWF0X2phbGFuIjoiU2VzdWFpICgxMDApIiwiZHVrY2FwaWxfa2V0ZXJhbmdhbl9ydCI6IlNlc3VhaSIsImR1a2NhcGlsX2tldGVyYW5nYW5fcnciOiJTZXN1YWkiLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX2Rlc2Ffa2VsdXJhaGFuIjoiVGlkYWsgU2VzdWFpIiwiZHVrY2FwaWxfa2V0ZXJhbmdhbl9rZWNhbWF0YW4iOiJUaWRhayBTZXN1YWkiLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX2thYnVwYXRlbl9rb3RhIjoiU2VzdWFpIiwiZHVrY2FwaWxfa2V0ZXJhbmdhbl9wcm92aW5zaSI6IlNlc3VhaSIsImR1a2NhcGlsX2tldGVyYW5nYW5fbmlrX2F5YWgiOiJTZXN1YWkiLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX25pa19pYnUiOiJTZXN1YWkiLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX25pa193YWxpIjpudWxsLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX25hbWFfYXlhaCI6IlNlc3VhaSAoMTAwKSIsImR1a2NhcGlsX2tldGVyYW5nYW5fbmFtYV9pYnUiOiJTZXN1YWkgKDEwMCkiLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX25hbWFfd2FsaSI6bnVsbCwiZHVrY2FwaWxfa2V0ZXJhbmdhbl9ub21vcl9ra19heWFoIjoiU2VzdWFpIiwiZHVrY2FwaWxfa2V0ZXJhbmdhbl9ub21vcl9ra19pYnUiOiJTZXN1YWkiLCJkdWtjYXBpbF9rZXRlcmFuZ2FuX25vbW9yX2trX3dhbGkiOm51bGwsInN0YXR1c19wZW5lcmltYWFuIjoxLCJzdGF0dXNfZGFmdGFyX3VsYW5nIjowLCJzZWtvbGFoX3R1anVhbiI6IlNEIE5FR0VSSSBTVVJBS0FSWUEgMDIiLCJzdWRhaF91YmFoX3Bhc3N3b3JkIjoxLCJpYXQiOjE3NTE1NTA3MDEsImV4cCI6MTc1MTYzNzEwMSwiaXNzIjoicHQtYnR1LmNvLmlkIiwic3ViIjoiZGV2ZWxvcG1lbnQtdGVhbUBwdC1idHUuY28uaWQifQ.Hb6rKJUu1Ycgzdnp1kR_YcQWR6YOZ9UHCVAE7f1IB7qZ5EAay3ol0oPT1iEECtZfJ0G-INPt9o0pW8Gv_wBXUbWaPPefkma5h8hrjnaOS3XXx7Ru0RzWkqnJfBq0kH_SdMBI8x1j7JL9d4B7_4F0iSo-BLRs3WK8GIc8XDlJsGBg8To-vkPwxJVziOeIZNEEd-tGNosVYVwgb1WpgX2-mpSgiCOrj-MMasZhqCTzE0RUi0ANv6BIMaYABNDlVFclKR8_d_9PTBWpOJJeEazKgxoM2a4eJ-roArIu-hIQxzmeyYfP1CUigpxTvAWCNJooNf1tgjj0prvLPauVZXG3Dw' \
  -H 'Connection: keep-alive' \
  -H 'Content-Type: application/json' \
  -H 'Origin: https://spmb.bogorkab.go.id' \
  -H 'Referer: https://spmb.bogorkab.go.id/' \
  -H 'Sec-Fetch-Dest: empty' \
  -H 'Sec-Fetch-Mode: cors' \
  -H 'Sec-Fetch-Site: same-origin' \
  -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/136.0.0.0 Safari/537.36' \
  -H 'sec-ch-ua: "Chromium";v="136", "Google Chrome";v="136", "Not.A/Brand";v="99"' \
  -H 'sec-ch-ua-mobile: ?0' \
  -H 'sec-ch-ua-platform: "macOS"' \
  --data-raw '{"pengguna_id":"5688268F-F8AB-416E-98C4-5856462EEA68"}')

# Extract peringkat
CURRENT_PERINGKAT=$(echo "$JSON" | jq -r '.data[0].peringkat')

# Read last value (if file doesn't exist, assume empty)
if [ -f "$LAST_VALUE_FILE" ]; then
  LAST_PERINGKAT=$(cat "$LAST_VALUE_FILE")
else
  LAST_PERINGKAT=""
fi

# Compare current vs last
if [ "$CURRENT_PERINGKAT" != "$LAST_PERINGKAT" ]; then
  # Save new value
  echo "$CURRENT_PERINGKAT" > "$LAST_VALUE_FILE"

  # Send email using mail (install `mailutils` or `bsd-mailx`)
  echo "Daniswara Raka Sanjaya - rank changed to $CURRENT_PERINGKAT"
  #| mail -s "Rank Update Alert" perdanahadisanjaya@gmail.com

  BOT_TOKEN="7878381653:AAGcuJUp6zqas4dUxmDkHf_0kWRLHIm-54M"
  CHAT_ID="90355776"  # Replace with your own Telegram ID
  MESSAGE="Daniswara Raka Sanjaya - rank changed to $CURRENT_PERINGKAT"

  curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
    -d chat_id="$CHAT_ID" \
    -d text="$MESSAGE"
fi
